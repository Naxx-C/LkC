#include "string_utils.h"
#include "algo_set_build.h"
#include "time_utils.h"
#include "arcfault_smartmode.h"
#include "algo_set.h"
#include <stdio.h>
#include <string.h>
#include <time.h>
#include <math.h>
#include "fft.h"
#ifdef _WIN32
#endif

static int init() {

    initTpsonAlgoLib();

    ArcfaultFlashOpsRegister(NULL);

    setModuleEnable(ALGO_CHARGING_DETECT, 1);
    setModuleEnable(ALGO_DORM_CONVERTER_DETECT, 1);
    setModuleEnable(ALGO_MALICIOUS_LOAD_DETECT, 1);
    setModuleEnable(ALGO_ARCFAULT_DETECT, 1);

    for (int channel = 0; channel < CHANNEL_NUM; channel++) {
        setChargingAlarmSensitivity(channel, CHARGING_ALARM_SENSITIVITY_MEDIUM);
        setMaliLoadAlarmSensitivity(channel, MALI_LOAD_SENSITIVITY_HIGH);
        setMinEventDeltaPower(channel, 55);
        setMinChargingDevicePower(channel, 55);
    }
    addMaliciousLoadWhitelist(1, 450);
    addMaliciousLoadWhitelist(1, 460);
    addMaliciousLoadWhitelist(1, 500);
    addMaliciousLoadWhitelist(1, 520);
    removeFromMaliLoadWhitelist(1, 490);
    return 0;
}

//static void sampleCall() {
//    //初始化
//    initTpsonAlgoLib();
//
//    //使能需要的算法模块
//    setModuleEnable(ALGO_CHARGING_DETECT, 1);
//    setModuleEnable(ALGO_DORM_CONVERTER_DETECT, 1);
//    setModuleEnable(ALGO_MALICIOUS_LOAD_DETECT, 1);
//    setModuleEnable(ALGO_ARCFAULT_DETECT, 1);
//
//    float current[128], voltage[128];
//    //送数据,传入电流电压采样buff的起始指针
//    feedData(current, voltage, time(NULL), NULL);
//
//    //获取算法结果
//    if(getChargingDetectResult()){
//        //do something
//    };
//    if(getDormConverterDetectResult()){
//        //do something
//    };
//    if(getMaliLoadDetectResult()){
//        //do something
//    };
//    int arcNum=0,onePeriodNum=0;
//    if(getArcfaultDetectResult(&arcNum,&onePeriodNum)){
//        //do something
//    };
//}

static float gSimulatedCurrent[128] = { 0.5859375, -0.1953125, -0.048828125, -0.14648438, -0.048828125,
        -0.09765625, -0.048828125, -0.048828125, -0.14648438, -0.09765625, -0.14648438, -0.048828125,
        -0.09765625, -0.14648438, -0.09765625, -0.09765625, -0.14648438, -0.14648438, -0.24414062,
        -0.29296875, -0.29296875, -0.29296875, -0.29296875, -0.24414062, -0.1953125, -0.29296875, -0.09765625,
        -0.09765625, -0.14648438, -0.048828125, -0.14648438, -0.14648438, -0.14648438, -0.14648438,
        -0.1953125, -0.1953125, -0.1953125, -0.1953125, -0.14648438, -0.24414062, -0.1953125, -0.14648438,
        -0.1953125, -11.328125, -11.279297, -11.083984, -10.791016, -10.253906, -9.472656, -8.837891,
        -8.300781, -7.763672, -7.1777344, -6.689453, -6.25, -5.810547, -5.2246094, -4.638672, -4.0039062,
        -3.3691406, -2.734375, -2.2460938, -1.6601562, -1.0742188, -0.390625, 0.09765625, 0.09765625,
        0.09765625, 0.14648438, 0.14648438, 0.14648438, 0.1953125, 0.14648438, 0.1953125, 0.1953125,
        0.14648438, 0.14648438, 0.09765625, 0.09765625, 0.14648438, 0.1953125, 0.14648438, 0.29296875,
        0.14648438, 0.29296875, 0.14648438, 0.14648438, 0.24414062, 0.24414062, 0.14648438, 0.14648438,
        0.14648438, 0.09765625, 0.14648438, 0.14648438, 0.29296875, 0.14648438, 0.1953125, 0.24414062,
        0.24414062, 0.1953125, 0.34179688, 0.29296875, 0.29296875, 0.24414062, 0.34179688, 0.14648438,
        11.279297, 11.230469, 11.181641, 10.888672, 10.253906, 9.667969, 8.7890625, 8.349609, 7.9589844,
        7.3242188, 6.8359375, 6.298828, 5.9570312, 5.2246094, 4.638672, 4.1503906, 3.3691406, 2.7832031,
        2.1972656, 1.7578125, 1.2207031 };
static float gSimulatedVoltage[128] = { 55.664062, 38.430607, 20.852482, 3.9636948, -12.925092, -27.22886,
        -41.877296, -55.319393, -68.93382, -83.237595, -96.67969, -110.81112, -125.6319, -140.108, -155.27344,
        -169.40488, -182.84697, -198.18474, -214.21185, -227.13695, -236.61536, -243.68106, -248.8511,
        -252.64246, -256.26147, -259.7082, -262.12085, -266.2569, -270.04825, -274.7013, -279.87134,
        -284.1797, -289.1774, -294.3474, -297.79413, -301.2408, -303.6535, -305.7215, -307.27252, -308.1342,
        -309.51288, -310.2022, -310.7192, -309.1682, -307.44485, -305.89383, -303.82584, -298.6558,
        -288.48804, -276.59695, -262.46555, -247.98943, -233.68567, -219.3819, -205.07812, -192.32536,
        -178.71094, -163.89017, -149.75873, -134.0763, -117.87684, -101.67739, -86.16728, -70.657166,
        -54.45772, -37.74127, -20.335478, -2.9296875, 12.925092, 28.779871, 43.08364, 56.525734, 70.657166,
        83.75459, 97.88603, 112.53447, 126.6659, 141.48668, 155.79044, 170.26654, 184.22565, 198.52942,
        213.17786, 226.27527, 236.61536, 243.68106, 249.88512, 254.53815, 258.15717, 261.60385, 264.8782,
        267.63556, 270.73758, 274.7013, 279.00964, 283.49036, 288.14337, 292.79642, 296.7601, 300.2068,
        302.7918, 305.03217, 306.75552, 307.96185, 308.99585, 310.02988, 310.89154, 308.99585, 307.1002,
        305.7215, 303.48117, 297.2771, 286.7647, 273.15027, 260.56985, 246.95543, 232.99632, 219.20956,
        205.42279, 190.77435, 177.5046, 164.23483, 148.72473, 133.38695, 117.87684, 100.98805, 86.339615,
        69.967834 };

void main2() {

//     initTpsonAlgoLib();
    init();

    for (int j = 0; j < 10240; j++) {
        feedData(0, gSimulatedCurrent, gSimulatedVoltage, time(NULL), NULL);
    }
}

